
-- __________________  Dump Tables to Start Fresh __________________
DROP TABLE PERSON CASCADE;
DROP TABLE ADDRESS CASCADE;
DROP TABLE ADDRESS_TYPE CASCADE;
DROP TABLE BILLING_INFO CASCADE;
DROP TABLE CARD_TYPE CASCADE;
DROP TABLE USER_REVIEW CASCADE;
DROP TABLE LOGIN CASCADE;
DROP TABLE AUCTION CASCADE;
DROP TABLE AUCTION_STATUS CASCADE;
DROP TABLE ITEM_CATEGORY CASCADE;
DROP TABLE ITEM_CONDITION CASCADE;
DROP TABLE BID CASCADE;
DROP TABLE WATCHED_ITEMS CASCADE;


-- __________________  Create Tables Fresh __________________
CREATE TABLE PERSON (
	USER_ID INTEGER PRIMARY KEY,
	USERNAME VARCHAR(40) NOT NULL,
	LAST_NAME VARCHAR(96) NOT NULL,
	FIRST_NAME VARCHAR(96) NOT NULL,
	EMAIL_ADDRESS VARCHAR(255) NOT NULL,
	USER_PHOTO bytea );

CREATE TABLE ADDRESS (
	ADDRESS_ID INTEGER PRIMARY KEY,
	USER_ID INTEGER NOT NULL,
	KIND INTEGER NOT NULL,
	NAME VARCHAR(255) NOT NULL,
	STREET_1 VARCHAR(100) NOT NULL,
	STREET_2 VARCHAR(100),
    CITY VARCHAR(75) NOT NULL,
    STATE VARCHAR(2) NOT NULL,
    ZIP INTEGER NOT NULL  );

CREATE TABLE ADDRESS_TYPE (
	ADDRESS_TYPE_ID INTEGER PRIMARY KEY,
	NAME VARCHAR(40) NOT NULL );

CREATE TABLE BILLING_INFO (
    BILLING_INFO_ID INTEGER PRIMARY KEY,
	USER_ID INTEGER NOT NULL,
	LAST_NAME VARCHAR(96) NOT NULL,
	FIRST_NAME VARCHAR(96) NOT NULL,
	CARD_TYPE INTEGER NOT NULL,
	CARD_NUMBER VARCHAR(19) NOT NULL,
	EXP_MONTH INTEGER NOT NULL,
	EXP_DAY INTEGER NOT NULL,
	SECURITY_CODE INTEGER NOT NULL ); 

CREATE TABLE CARD_TYPE (
	CARD_TYPE_ID INTEGER PRIMARY KEY,
	CARD_NAME VARCHAR(20) NOT NULL );

CREATE TABLE USER_REVIEW (
	USER_REVIEW_ID INTEGER PRIMARY KEY,
	USER_ID_FOR INTEGER NOT NULL,
	USER_ID_BY INTEGER NOT NULL,
	RELIABILITY INTEGER NOT NULL,
	HONESTY INTEGER NOT NULL,
	TIMELINESS INTEGER NOT NULL,
	OVERALL INTEGER NOT NULL,
	BUY_AGAIN BOOLEAN NOT NULL );

CREATE TABLE LOGIN (
	USER_ID INTEGER PRIMARY KEY,
	PWD_HASH VARCHAR(255) NOT NULL );

CREATE TABLE AUCTION (
	AUCTION_ID INTEGER PRIMARY KEY,
	STATUS INTEGER NOT NULL,
	SELLER INTEGER NOT NULL,
    CURRENT_BID_ID INTEGER,
	STARTING_BID NUMERIC(7,2),
	RESERVE_PRICE NUMERIC(7,2),
	OPEN_TIME TIMESTAMP NOT NULL,
	CLOSE_TIME TIMESTAMP NOT NULL,
	ITEM_CATEGORY INTEGER,
	ITEM_NAME VARCHAR(78),
	ITEM_DESCRIPTION TEXT,
	ITEM_CONDITION INTEGER NOT NULL,
	ITEM_PHOTO bytea,
	PAID BOOLEAN );

CREATE TABLE AUCTION_STATUS (
	AUCTION_STATUS_ID INTEGER PRIMARY KEY,
	NAME VARCHAR(20) NOT NULL );

CREATE TABLE ITEM_CATEGORY (
	ITEM_CATEGORY_ID INTEGER PRIMARY KEY,
	NAME VARCHAR(78) NOT NULL );

CREATE TABLE ITEM_CONDITION (
	ITEM_CONDITION_ID INTEGER PRIMARY KEY,
	NAME VARCHAR(20) NOT NULL );

CREATE TABLE BID (
	BID_ID INTEGER PRIMARY KEY,
	BIDDER INTEGER NOT NULL,
	AUCTION INTEGER NOT NULL,
	BID_TIME TIMESTAMP NOT NULL,
	AMOUNT NUMERIC(9,2) NOT NULL );

CREATE TABLE WATCHED_ITEMS (
    WATCHED_ITEMS_ID INTEGER PRIMARY KEY,
	USER_ID INTEGER NOT NULL, 
	ITEM_ID INTEGER NOT NULL );


-- __________________  Create Indecies __________________
CREATE INDEX AUCTION_STATUS_NAME_INDEX ON AUCTION_STATUS (NAME);
CREATE INDEX ITEM_CATEGORY_NAME_INDEX ON ITEM_CATEGORY (NAME);
CREATE INDEX AUCTION_STATUS_INDEX ON AUCTION (STATUS);
CREATE INDEX AUCTION_SELLER_INDEX ON AUCTION (SELLER);
CREATE INDEX AUCTION_ITEM_CATEGORY_INDEX ON AUCTION (ITEM_CATEGORY);
CREATE INDEX BID_AUCTION_INDEX ON BID (AUCTION);
CREATE INDEX BID_BIDDER_INDEX ON BID (BIDDER);


-- __________________  Add Foreign Keys __________________
ALTER TABLE ADDRESS ADD FOREIGN KEY (USER_ID) REFERENCES PERSON(USER_ID) DEFERRABLE;
ALTER TABLE ADDRESS ADD FOREIGN KEY (KIND) REFERENCES ADDRESS_TYPE(ADDRESS_TYPE_ID) DEFERRABLE;
ALTER TABLE BILLING_INFO ADD FOREIGN KEY (USER_ID) REFERENCES PERSON(USER_ID) DEFERRABLE;
ALTER TABLE BILLING_INFO ADD FOREIGN KEY (CARD_TYPE) REFERENCES CARD_TYPE(CARD_TYPE_ID) DEFERRABLE;
ALTER TABLE USER_REVIEW ADD FOREIGN KEY (USER_ID_FOR) REFERENCES PERSON(USER_ID) DEFERRABLE;
ALTER TABLE USER_REVIEW ADD FOREIGN KEY (USER_ID_BY) REFERENCES PERSON(USER_ID) DEFERRABLE;
ALTER TABLE LOGIN ADD FOREIGN KEY (USER_ID) REFERENCES PERSON(USER_ID) DEFERRABLE;
ALTER TABLE AUCTION ADD FOREIGN KEY (SELLER) REFERENCES PERSON(USER_ID) DEFERRABLE;
ALTER TABLE AUCTION ADD FOREIGN KEY (STATUS) REFERENCES AUCTION_STATUS(AUCTION_STATUS_ID) DEFERRABLE;
ALTER TABLE AUCTION ADD FOREIGN KEY (ITEM_CATEGORY) REFERENCES ITEM_CATEGORY(ITEM_CATEGORY_ID) DEFERRABLE;
ALTER TABLE AUCTION ADD FOREIGN KEY (CURRENT_BID_ID) REFERENCES BID(BID_ID) DEFERRABLE;
ALTER TABLE AUCTION ADD FOREIGN KEY (ITEM_CONDITION) REFERENCES ITEM_CONDITION(ITEM_CONDITION_ID) DEFERRABLE;
ALTER TABLE BID ADD FOREIGN KEY (BIDDER) REFERENCES PERSON(USER_ID) DEFERRABLE;
ALTER TABLE BID ADD FOREIGN KEY (AUCTION) REFERENCES AUCTION(AUCTION_ID) DEFERRABLE;
ALTER TABLE WATCHED_ITEMS ADD FOREIGN KEY (USER_ID) REFERENCES PERSON(USER_ID) DEFERRABLE;



-- __________________  Create Sequence Generator __________________
DROP TABLE SEQ;
DROP FUNCTION NEXT_SEQ_VALUE;

CREATE TABLE SEQ (
    NAME VARCHAR(30) PRIMARY KEY,
    CURRENT_VALUE INTEGER NOT NULL );


-- The use of LAST_INSERT_ID is a MySQL-specific trick to
-- eliminate the need for an explicit transaction here.

-- From: Zaitsev, Peter. "Stored function to generate sequences". MySQL
--   Performance Blog. Pleasanton, Calif.: Percona LLC, 2008 Apr 2.
--   URL: http://www.mysqlperformanceblog.com/2008/04/02/stored-function-to-generate-sequences/

delimiter //
CREATE FUNCTION NEXT_SEQ_VALUE(SEQ_NAME VARCHAR(30))
    RETURNS INT
    MODIFIES SQL DATA
BEGIN
    UPDATE SEQ
        SET
            CURRENT_VALUE = LAST_INSERT_ID(CURRENT_VALUE+1)
        WHERE NAME = SEQ_NAME;
    RETURN LAST_INSERT_ID();
END
//
delimiter ;


INSERT INTO SEQ SELECT 'ADDRESS', MAX(ADDRESS_ID) FROM ADDRESS;
INSERT INTO SEQ SELECT 'ADDRESS_TYPE', MAX(ADDRESS_TYPE_ID) FROM ADDRESS_TYPE;
INSERT INTO SEQ SELECT 'AUCTION', MAX(AUCTION_ID) FROM AUCTION;
INSERT INTO SEQ SELECT 'AUCTION_STATUS', MAX(AUCTION_STATUS_ID) FROM AUCTION_STATUS;
INSERT INTO SEQ SELECT 'BID', MAX(BID_ID) FROM BID;
INSERT INTO SEQ SELECT 'BILLING_INFO', MAX(BILLING_INFO_ID) FROM BILLING_INFO;
INSERT INTO SEQ SELECT 'CARD_TYPE', MAX(CARD_TYPE_ID) FROM CARD_TYPE;
INSERT INTO SEQ SELECT 'ITEM_CATEGORY', MAX(ITEM_CATEGORY_ID) FROM ITEM_CATEGORY;
INSERT INTO SEQ SELECT 'ITEM_CONDITION', MAX(ITEM_CONDITION_ID) FROM ITEM_CONDITION;
INSERT INTO SEQ SELECT 'LOGIN', MAX(LOGIN_ID) FROM LOGIN;
INSERT INTO SEQ SELECT 'PERSON', MAX(USER_ID) FROM PERSON;
INSERT INTO SEQ SELECT 'USER_REVIEW', MAX(USER_REVIEW_ID) FROM USER_REVIEW;
INSERT INTO SEQ SELECT 'WATCHED_ITEMS', MAX(WATCHED_ITEMS_ID) FROM WATCHED_ITEMS;
